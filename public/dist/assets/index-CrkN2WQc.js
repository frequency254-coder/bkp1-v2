(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))u(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const d of s.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&u(d)}).observe(document,{childList:!0,subtree:!0});function l(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function u(r){if(r.ep)return;r.ep=!0;const s=l(r);fetch(r.href,s)}})();(function(){if(window.__appInitialized)return console.info("App: already initialized"),window.__appInstance||null;window.__appInitialized=!0;const c={apiBase:"/api",pageSize:12,fetchRetries:3,fetchBackoffMs:300,debug:!!window.location.search.includes("app_debug")},e={pageType:window.pageType||"movies",currentPage:1,totalPages:1,currentGenre:"all",currentSearch:"",isLoading:!1,items:[]},l=t=>document.querySelector(t),u=t=>Array.from(document.querySelectorAll(t)),r=t=>document.getElementById(t)||null;async function s(t,o={},i=c.fetchRetries){let a=0;for(;;)try{const n=await fetch(t,o);if(!n.ok){if(n.status>=500&&a<i)throw new Error(`server ${n.status}`);return n}return n}catch(n){if(a+=1,a>i)throw n;const f=c.fetchBackoffMs*Math.pow(2,a-1);c.debug&&console.warn(`fetch retry ${a} for ${t} after ${f}ms`,n),await new Promise(_=>setTimeout(_,f))}}function d(t=[]){const o=r("grid")||l(".grid")||null;if(!o){c.debug&&console.warn("renderItems: grid not found");return}o.innerHTML="";const i=document.createDocumentFragment();t.forEach(a=>{const n=document.createElement("div");n.className="card mb-3",n.dataset.id=a.id||a._id||"",n.innerHTML=`
        <img src="${a.poster||"/images/placeholder.jpg"}" alt="${g(a.title||"")}" class="card-img-top" />
        <div class="card-body">
          <h5 class="card-title">${g(a.title||"Untitled")}</h5>
          <p class="card-text small">${g(a.releaseYear||"")}</p>
        </div>
      `,i.appendChild(n)}),o.appendChild(i)}function g(t){return!t&&t!==0?"":String(t).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;")}async function p({page:t=1,pageSize:o=c.pageSize}={}){if(e.isLoading)return;e.isLoading=!0,h(!0);const i=new URLSearchParams({page:t,pageSize:o,genre:e.currentGenre,search:e.currentSearch,type:e.pageType});try{const a=await s(`${c.apiBase}/items?${i.toString()}`,{method:"GET"});if(!a.ok){console.error("loadPage failed",a.status),m(`Load failed: ${a.status}`);return}const n=await a.json();e.items=Array.isArray(n.items)?n.items:[],e.totalPages=n.totalPages||1,e.currentPage=t,d(e.items)}catch(a){console.error("loadPage error",a),m("Network error. Check console.")}finally{e.isLoading=!1,h(!1)}}function h(t){const o=r("loading")||u(".loading")[0];o&&(o.style.display=t?"block":"none")}function m(t,o=4e3){let i=r("appBanner");i||(i=document.createElement("div"),i.id="appBanner",i.style.position="fixed",i.style.right="12px",i.style.top="12px",i.style.zIndex=9999,document.body.appendChild(i)),i.textContent=t,i.style.display="block",setTimeout(()=>i.style.display="none",o)}function y(){const t=r("nextBtn");t&&t.replaceWith(t.cloneNode(!0));const o=r("nextBtn")||l(".next-btn");o&&o.addEventListener("click",()=>{const n=Math.min(e.totalPages,e.currentPage+1);n!==e.currentPage&&p({page:n})});const i=r("prevBtn")||l(".prev-btn");i&&(i.replaceWith(i.cloneNode(!0)),r("prevBtn")?.addEventListener("click",()=>{const n=Math.max(1,e.currentPage-1);n!==e.currentPage&&p({page:n})}));const a=r("searchInput")||l("#searchInput");if(a){let n=null;const f=()=>{clearTimeout(n),n=setTimeout(()=>{e.currentSearch=a.value.trim(),p({page:1})},350)};a.addEventListener("input",f)}}async function P(t={}){if(window.__appInitializing){c.debug&&console.info("init already in progress");return}window.__appInitializing=!0;try{t.overridePageType&&(e.pageType=t.overridePageType),y();try{const o=await s(`${c.apiBase}/ping`,{method:"GET"},1);!o.ok&&c.debug&&console.warn("health ping non-ok",o.status)}catch(o){console.warn("health ping failed",o)}await p({page:e.currentPage}),c.debug&&console.info("App initialized",e)}finally{window.__appInitializing=!1}}const w={CONFIG:c,state:e,init:P,loadPage:p,fetchWithRetries:s,renderItems:d,_resetForTest:()=>{window.__appInitialized=!1,e.currentPage=1,e.items=[]}};return window.__appInstance=w,w})();window.APP_AUTO_INIT!==!1&&document.addEventListener("DOMContentLoaded",()=>{const c=window.APP_INIT_OPTS||{};window.__appInstance&&window.__appInstance.init(c).catch(e=>{console.error("Auto init failed",e)})});
